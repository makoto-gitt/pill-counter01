<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>錠剤カウンター</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      text-align: center;
    }
    video, canvas {
      margin-top: 10px;
      width: 100%;
      max-width: 400px;
      border: 1px solid #ddd;
    }
    button {
      margin: 10px 0;
      padding: 10px 20px;
      font-size: 16px;
    }
    p {
      font-size: 18px;
      margin: 10px 0;
    }
  </style>
  <!-- TensorFlow.jsの読み込み -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
</head>
<body>
  <h1>錠剤カウンター</h1>
  <p>必要な錠剤の数を入力してください:</p>
  <input type="number" id="requiredPills" placeholder="必要数" />
  <button onclick="startCamera()">カメラを起動</button>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
  <p id="result"></p>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const result = document.getElementById("result");
    let stream;
    let model;

    async function startCamera() {
      // TensorFlow.jsモデルの読み込み
      model = await cocoSsd.load();
      console.log("Model loaded");

      try {
        // 外カメラの設定 (facingMode: "environment" で背面カメラを指定)
        const constraints = {
          video: {
            facingMode: "environment", // 外カメラを使用
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        };

        // カメラを取得
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;

        // 錠剤の検出を開始
        detectPills();
      } catch (error) {
        console.error(error);
        result.textContent = "カメラにアクセスできませんでした。エラー: " + error.message;
      }
    }

    async function detectPills() {
      const ctx = canvas.getContext("2d");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      async function processFrame() {
        // カメラ映像をキャプチャ
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // 物体検出を実行
        const predictions = await model.detect(canvas);

        let pillCount = 0;
        
        // 検出された物体を確認
        predictions.forEach(prediction => {
          // 錠剤を検出 (物体名が 'bottle' や 'cup' など、適切なラベルを使用)
          if (prediction.class === 'bottle' || prediction.class === 'cup') {
            // 錠剤の形状を円形かどうかを確認
            const [x, y, width, height] = prediction.bbox;
            const radius = Math.min(width, height) / 2;
            const aspectRatio = width / height;

            // 近似円形を定義 (アスペクト比が1に近ければ円形と判断)
            if (aspectRatio > 0.8 && aspectRatio < 1.2) {
              pillCount++;
              // 錠剤を囲む緑の枠を描画
              ctx.beginPath();
              ctx.arc(x + radius, y + radius, radius, 0, 2 * Math.PI);
              ctx.lineWidth = 4;
              ctx.strokeStyle = 'green';
              ctx.fillStyle = 'green';
              ctx.stroke();
              ctx.fillText(prediction.class, x + radius, y + radius > 10 ? y + radius - 5 : 10);
            }
          }
        });

        // 検出された錠剤の数を表示
        result.textContent = `検出された錠剤の数: ${pillCount}`;

        // 次のフレームを処理
        requestAnimationFrame(processFrame);
      }

      // 最初のフレームを処理
      processFrame();
    }
  </script>
</body>
</html>
